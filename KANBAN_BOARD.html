<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸŽ© Gatsby's Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        * { font-family: 'Inter', sans-serif; }
        
        .glass {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .column { min-height: 200px; }
        
        .card {
            transition: all 0.2s ease;
            cursor: grab;
        }
        
        .card:active { cursor: grabbing; }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.5);
        }
        
        .status-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .priority-high { border-left: 4px solid #ef4444; }
        .priority-medium { border-left: 4px solid #f59e0b; }
        .priority-low { border-left: 4px solid #10b981; }
        
        .column-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Date picker styling */
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 min-h-screen">
    <!-- Header with Live Status -->
    <header class="glass fixed top-0 left-0 right-0 z-50 px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-xl flex items-center justify-center text-2xl shadow-lg shadow-cyan-500/20">
                    ðŸŽ©
                </div>
                <div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-cyan-400 to-blue-400 bg-clip-text text-transparent">
                        Gatsby's Command Center
                    </h1>
                    <p class="text-sm text-slate-400">Project Management Dashboard</p>
                </div>
            </div>
            
            <!-- Live Status Indicator -->
            <div class="flex items-center gap-4">
                <div id="connection-status" class="flex items-center gap-2 text-xs text-slate-500">
                    <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                    Connected
                </div>
                <div id="status-indicator" class="flex items-center gap-2 px-4 py-2 rounded-full bg-emerald-500/10 border border-emerald-500/30 cursor-pointer" onclick="showStatusModal()">
                    <div class="w-3 h-3 rounded-full bg-emerald-500 status-pulse" id="status-dot"></div>
                    <span class="text-sm font-medium text-emerald-400" id="status-text">Active</span>
                </div>
                <div id="activity-text" class="text-sm text-slate-400 hidden md:block">
                    Processing...
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="pt-24 pb-8 px-6">
        <div class="max-w-7xl mx-auto">
            <!-- Add Task Button -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-semibold text-slate-300">Project Board</h2>
                <div class="flex gap-3">
                    <button onclick="exportData()" class="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors text-sm">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Export
                    </button>
                    <button onclick="document.getElementById('import-file').click()" class="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors text-sm">
                        <i data-lucide="upload" class="w-4 h-4"></i>
                        Import
                    </button>
                    <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(this)">
                    <button onclick="addNewTask()" class="flex items-center gap-2 px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg font-medium transition-colors">
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Add Task
                    </button>
                </div>
            </div>

            <!-- Kanban Board -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Backlog Column -->
                <div class="glass rounded-xl flex flex-col max-h-[calc(100vh-220px)]">
                    <div class="column-header glass rounded-t-xl p-4 border-b border-slate-700/50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-slate-500"></div>
                                <h3 class="font-semibold">Backlog</h3>
                            </div>
                            <span class="text-xs bg-slate-700 px-2 py-1 rounded-full" id="count-backlog">0</span>
                        </div>
                    </div>
                    <div id="backlog" class="column flex-1 p-3 overflow-y-auto space-y-3" data-column="backlog"></div>
                </div>

                <!-- In Progress Column -->
                <div class="glass rounded-xl flex flex-col max-h-[calc(100vh-220px)]">
                    <div class="column-header glass rounded-t-xl p-4 border-b border-slate-700/50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-amber-500"></div>
                                <h3 class="font-semibold">In Progress</h3>
                            </div>
                            <span class="text-xs bg-amber-500/20 text-amber-400 px-2 py-1 rounded-full" id="count-progress">0</span>
                        </div>
                    </div>
                    <div id="progress" class="column flex-1 p-3 overflow-y-auto space-y-3" data-column="progress"></div>
                </div>

                <!-- Review Column -->
                <div class="glass rounded-xl flex flex-col max-h-[calc(100vh-220px)]">
                    <div class="column-header glass rounded-t-xl p-4 border-b border-slate-700/50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                                <h3 class="font-semibold">In Review</h3>
                            </div>
                            <span class="text-xs bg-blue-500/20 text-blue-400 px-2 py-1 rounded-full" id="count-review">0</span>
                        </div>
                    </div>
                    <div id="review" class="column flex-1 p-3 overflow-y-auto space-y-3" data-column="review"></div>
                </div>

                <!-- Done Column -->
                <div class="glass rounded-xl flex flex-col max-h-[calc(100vh-220px)]">
                    <div class="column-header glass rounded-t-xl p-4 border-b border-slate-700/50">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
                                <h3 class="font-semibold">Done</h3>
                            </div>
                            <span class="text-xs bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded-full" id="count-done">0</span>
                        </div>
                    </div>
                    <div id="done" class="column flex-1 p-3 overflow-y-auto space-y-3" data-column="done"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Task Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="glass rounded-xl p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4" id="modal-title">Add New Task</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Task Title *</label>
                    <input type="text" id="task-title" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-cyan-500" placeholder="Enter task title...">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Priority</label>
                        <select id="task-priority" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-cyan-500">
                            <option value="high">ðŸ”´ High</option>
                            <option value="medium">ðŸŸ¡ Medium</option>
                            <option value="low">ðŸŸ¢ Low</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-slate-400 mb-1">Due Date</label>
                        <input type="date" id="task-due" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-cyan-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Project/Context</label>
                    <input type="text" id="task-project" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-cyan-500" placeholder="e.g., Colombian Spanish, SpiceSync, Personal...">
                </div>
                
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Assigned To</label>
                    <input type="text" id="task-assignee" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-cyan-500" placeholder="e.g., Gatsby, Mike...">
                </div>
                
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Tags (comma separated)</label>
                    <input type="text" id="task-tags" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-cyan-500" placeholder="e.g., dev, design, urgent, feature">
                </div>
                
                <div>
                    <label class="block text-sm text-slate-400 mb-1">Notes/Comments</label>
                    <textarea id="task-notes" rows="3" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-cyan-500 resize-none" placeholder="Add any additional notes..."></textarea>
                </div>
                
                <div class="flex gap-3 pt-2">
                    <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors">Cancel</button>
                    <button onclick="saveTask()" class="flex-1 px-4 py-2 bg-cyan-600 hover:bg-cyan-500 rounded-lg font-medium transition-colors">Save Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Modal -->
    <div id="status-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="glass rounded-xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold mb-4">Update Status</h3>
            <div class="space-y-3">
                <button onclick="updateStatus('active', 'Processing...')" class="w-full flex items-center gap-3 p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/30 hover:bg-emerald-500/20 transition-colors">
                    <div class="w-3 h-3 rounded-full bg-emerald-500 status-pulse"></div>
                    <span class="font-medium">Active - Processing</span>
                </button>
                <button onclick="updateStatus('working', 'Working on task...')" class="w-full flex items-center gap-3 p-3 rounded-lg bg-cyan-500/10 border border-cyan-500/30 hover:bg-cyan-500/20 transition-colors">
                    <div class="w-3 h-3 rounded-full bg-cyan-500"></div>
                    <span class="font-medium">Working - Deep Focus</span>
                </button>
                <button onclick="updateStatus('thinking', 'Analyzing...')" class="w-full flex items-center gap-3 p-3 rounded-lg bg-amber-500/10 border border-amber-500/30 hover:bg-amber-500/20 transition-colors">
                    <div class="w-3 h-3 rounded-full bg-amber-500"></div>
                    <span class="font-medium">Thinking - Planning</span>
                </button>
                <button onclick="updateStatus('idle', 'Waiting...')" class="w-full flex items-center gap-3 p-3 rounded-lg bg-slate-500/10 border border-slate-500/30 hover:bg-slate-500/20 transition-colors">
                    <div class="w-3 h-3 rounded-full bg-slate-500"></div>
                    <span class="font-medium">Idle - Waiting for input</span>
                </button>
                <button onclick="closeStatusModal()" class="w-full px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg font-medium transition-colors mt-4">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // WebSocket connection (for live status)
        let ws = null;
        let reconnectAttempts = 0;
        
        function connectWebSocket() {
            // Try to connect to local status server
            try {
                ws = new WebSocket('ws://localhost:3000');
                
                ws.onopen = () => {
                    console.log('Connected to status server');
                    reconnectAttempts = 0;
                    document.getElementById('connection-status').innerHTML = `
                        <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                        Live
                    `;
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === 'status') {
                        updateStatusUI(data.data);
                    }
                };
                
                ws.onclose = () => {
                    document.getElementById('connection-status').innerHTML = `
                        <span class="w-2 h-2 rounded-full bg-slate-500"></span>
                        Offline
                    `;
                    // Try to reconnect
                    if (reconnectAttempts < 5) {
                        setTimeout(connectWebSocket, 5000);
                        reconnectAttempts++;
                    }
                };
                
                ws.onerror = (err) => {
                    console.error('WebSocket error:', err);
                };
            } catch (e) {
                console.log('Status server not available - running in standalone mode');
            }
        }
        
        function updateStatusUI(status) {
            const indicator = document.getElementById('status-indicator');
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            const activity = document.getElementById('activity-text');
            
            const colors = {
                active: { bg: 'bg-emerald-500/10', border: 'border-emerald-500/30', text: 'text-emerald-400', dot: 'bg-emerald-500' },
                working: { bg: 'bg-cyan-500/10', border: 'border-cyan-500/30', text: 'text-cyan-400', dot: 'bg-cyan-500' },
                thinking: { bg: 'bg-amber-500/10', border: 'border-amber-500/30', text: 'text-amber-400', dot: 'bg-amber-500' },
                idle: { bg: 'bg-slate-500/10', border: 'border-slate-500/30', text: 'text-slate-400', dot: 'bg-slate-500' }
            };
            
            const color = colors[status.state] || colors.active;
            
            indicator.className = `flex items-center gap-2 px-4 py-2 rounded-full ${color.bg} border ${color.border} cursor-pointer`;
            dot.className = `w-3 h-3 rounded-full ${color.dot} ${status.state === 'active' ? 'status-pulse' : ''}`;
            text.className = `text-sm font-medium ${color.text}`;
            text.textContent = status.state.charAt(0).toUpperCase() + status.state.slice(1);
            activity.textContent = status.activity;
        }
        
        function updateStatus(state, activity) {
            const status = { state, activity, lastUpdate: Date.now() };
            updateStatusUI(status);
            
            // Send to server if connected
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'status', data: status }));
            }
            
            // Also save to localStorage for persistence
            localStorage.setItem('gatsby-status', JSON.stringify(status));
            closeStatusModal();
        }
        
        function showStatusModal() {
            document.getElementById('status-modal').classList.remove('hidden');
            document.getElementById('status-modal').classList.add('flex');
        }
        
        function closeStatusModal() {
            document.getElementById('status-modal').classList.add('hidden');
            document.getElementById('status-modal').classList.remove('flex');
        }
        
        // Load saved status
        const savedStatus = localStorage.getItem('gatsby-status');
        if (savedStatus) {
            updateStatusUI(JSON.parse(savedStatus));
        }
        
        // Connect WebSocket
        connectWebSocket();

        // Sample initial data
        const initialTasks = {
            backlog: [
                { id: '1', title: 'Create app icons (1024x1024)', priority: 'high', project: 'Colombian Spanish', assignee: 'Gatsby', due: '2026-02-10', tags: ['design', 'app-store'], notes: 'Need professional icons for App Store' },
                { id: '2', title: 'Research competitor features', priority: 'medium', project: 'General', assignee: 'Gatsby', due: '', tags: ['research'], notes: '' },
            ],
            progress: [
                { id: '3', title: 'Build interactive Kanban board', priority: 'high', project: 'General', assignee: 'Gatsby', due: '2026-02-04', tags: ['dev', 'tools'], notes: 'Add drag-drop, WebSocket status, export/import' },
            ],
            review: [
                { id: '4', title: 'All PRs merged for Colombian Spanish', priority: 'high', project: 'Colombian Spanish', assignee: 'Gatsby', due: '2026-02-04', tags: ['dev', 'merged'], notes: '8 PRs total, all CI passing' },
            ],
            done: [
                { id: '5', title: 'Set up CI/CD pipeline', priority: 'high', project: 'Colombian Spanish', assignee: 'Gatsby', due: '2026-02-04', tags: ['devops', 'ci'], notes: 'GitHub Actions with lint, typecheck, validation' },
                { id: '6', title: 'Content blitz - 1,016 cards', priority: 'high', project: 'Colombian Spanish', assignee: 'Gatsby', due: '2026-02-03', tags: ['content'], notes: 'Added 234 new cards across 4 decks' },
            ]
        };

        // Load from localStorage or use initial
        function loadTasks() {
            const saved = localStorage.getItem('kanban-tasks-v2');
            return saved ? JSON.parse(saved) : initialTasks;
        }

        function saveTasks() {
            const tasks = {
                backlog: getColumnTasks('backlog'),
                progress: getColumnTasks('progress'),
                review: getColumnTasks('review'),
                done: getColumnTasks('done')
            };
            localStorage.setItem('kanban-tasks-v2', JSON.stringify(tasks));
            updateCounts();
        }

        function getColumnTasks(columnId) {
            const column = document.getElementById(columnId);
            return Array.from(column.children).map(card => ({
                id: card.dataset.id,
                title: card.querySelector('.card-title').textContent,
                priority: card.dataset.priority,
                project: card.dataset.project,
                assignee: card.dataset.assignee,
                due: card.dataset.due,
                tags: JSON.parse(card.dataset.tags || '[]'),
                notes: card.dataset.notes
            }));
        }

        function createCard(task) {
            const priorityColors = {
                high: 'priority-high border-red-500',
                medium: 'priority-medium border-amber-500',
                low: 'priority-low border-emerald-500'
            };

            const isOverdue = task.due && new Date(task.due) < new Date() && new Date(task.due).toDateString() !== new Date().toDateString();
            const dueClass = isOverdue ? 'text-red-400' : 'text-slate-500';

            const div = document.createElement('div');
            div.className = `card glass rounded-lg p-3 border-l-4 ${priorityColors[task.priority]}`;
            div.dataset.id = task.id;
            div.dataset.priority = task.priority;
            div.dataset.project = task.project || '';
            div.dataset.assignee = task.assignee || '';
            div.dataset.due = task.due || '';
            div.dataset.tags = JSON.stringify(task.tags || []);
            div.dataset.notes = task.notes || '';
            
            div.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    ${task.project ? `<span class="text-xs px-2 py-0.5 rounded bg-slate-700/50 text-slate-300 truncate max-w-[120px]">${task.project}</span>` : '<span></span>'}
                    <div class="flex gap-1">
                        <button onclick="editTask('${task.id}')" class="text-slate-500 hover:text-cyan-400 transition-colors p-1">
                            <i data-lucide="edit-2" class="w-3 h-3"></i>
                        </button>
                        <button onclick="deleteTask('${task.id}')" class="text-slate-500 hover:text-red-400 transition-colors p-1">
                            <i data-lucide="x" class="w-3 h-3"></i>
                        </button>
                    </div>
                </div>
                <h4 class="card-title font-medium text-sm mb-2 text-slate-200">${task.title}</h4>
                ${task.notes ? `<p class="text-xs text-slate-500 mb-2 line-clamp-2">${task.notes}</p>` : ''}
                <div class="flex flex-wrap gap-1 mb-2">
                    ${(task.tags || []).map(tag => `
                        <span class="text-xs bg-slate-700/50 text-slate-400 px-1.5 py-0.5 rounded">${tag}</span>
                    `).join('')}
                </div>
                <div class="flex items-center justify-between text-xs">
                    ${task.assignee ? `<span class="text-slate-400 flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> ${task.assignee}</span>` : '<span></span>'}
                    ${task.due ? `<span class="${dueClass} flex items-center gap-1"><i data-lucide="calendar" class="w-3 h-3"></i> ${new Date(task.due).toLocaleDateString()}</span>` : ''}
                </div>
            `;
            return div;
        }

        function renderTasks() {
            const tasks = loadTasks();
            
            Object.keys(tasks).forEach(columnId => {
                const column = document.getElementById(columnId);
                column.innerHTML = '';
                tasks[columnId].forEach(task => {
                    column.appendChild(createCard(task));
                });
            });
            
            lucide.createIcons();
            updateCounts();
        }

        function updateCounts() {
            ['backlog', 'progress', 'review', 'done'].forEach(id => {
                const count = document.getElementById(id).children.length;
                document.getElementById(`count-${id}`).textContent = count;
            });
        }

        // Initialize Sortable
        ['backlog', 'progress', 'review', 'done'].forEach(id => {
            new Sortable(document.getElementById(id), {
                group: 'kanban',
                animation: 150,
                ghostClass: 'bg-slate-700/50',
                dragClass: 'opacity-50',
                onEnd: saveTasks
            });
        });

        // Modal functions
        let editingTaskId = null;

        function addNewTask() {
            editingTaskId = null;
            document.getElementById('modal-title').textContent = 'Add New Task';
            document.getElementById('task-title').value = '';
            document.getElementById('task-priority').value = 'medium';
            document.getElementById('task-project').value = '';
            document.getElementById('task-assignee').value = 'Gatsby';
            document.getElementById('task-due').value = '';
            document.getElementById('task-tags').value = '';
            document.getElementById('task-notes').value = '';
            
            document.getElementById('task-modal').classList.remove('hidden');
            document.getElementById('task-modal').classList.add('flex');
            document.getElementById('task-title').focus();
        }

        function editTask(id) {
            const card = document.querySelector(`[data-id="${id}"]`);
            if (!card) return;
            
            editingTaskId = id;
            document.getElementById('modal-title').textContent = 'Edit Task';
            document.getElementById('task-title').value = card.querySelector('.card-title').textContent;
            document.getElementById('task-priority').value = card.dataset.priority;
            document.getElementById('task-project').value = card.dataset.project;
            document.getElementById('task-assignee').value = card.dataset.assignee;
            document.getElementById('task-due').value = card.dataset.due;
            document.getElementById('task-tags').value = JSON.parse(card.dataset.tags || '[]').join(', ');
            document.getElementById('task-notes').value = card.dataset.notes;
            
            document.getElementById('task-modal').classList.remove('hidden');
            document.getElementById('task-modal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('task-modal').classList.add('hidden');
            document.getElementById('task-modal').classList.remove('flex');
            editingTaskId = null;
        }

        function saveTask() {
            const title = document.getElementById('task-title').value;
            if (!title) return;
            
            const task = {
                id: editingTaskId || Date.now().toString(),
                title,
                priority: document.getElementById('task-priority').value,
                project: document.getElementById('task-project').value,
                assignee: document.getElementById('task-assignee').value,
                due: document.getElementById('task-due').value,
                tags: document.getElementById('task-tags').value.split(',').map(t => t.trim()).filter(t => t),
                notes: document.getElementById('task-notes').value
            };
            
            if (editingTaskId) {
                // Update existing
                const oldCard = document.querySelector(`[data-id="${editingTaskId}"]`);
                if (oldCard) {
                    const newCard = createCard(task);
                    oldCard.parentNode.replaceChild(newCard, oldCard);
                }
            } else {
                // Add new to backlog
                const card = createCard(task);
                document.getElementById('backlog').appendChild(card);
            }
            
            lucide.createIcons();
            saveTasks();
            closeModal();
        }

        function deleteTask(id) {
            if (!confirm('Delete this task?')) return;
            const card = document.querySelector(`[data-id="${id}"]`);
            if (card) {
                card.remove();
                saveTasks();
            }
        }

        // Export/Import
        function exportData() {
            const data = loadTasks();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `kanban-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    localStorage.setItem('kanban-tasks-v2', JSON.stringify(data));
                    renderTasks();
                    alert('Data imported successfully!');
                } catch (err) {
                    alert('Error importing data: ' + err.message);
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // Close modals on outside click
        document.getElementById('task-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal();
        });

        document.getElementById('status-modal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeStatusModal();
        });

        // Initial render
        renderTasks();
    </script>
</body>
</html>
